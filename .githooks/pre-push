#!/bin/bash

# Git pre-push hook for code quality checks
# This hook runs before pushing to remote repository

set -e

echo "Running pre-push code quality checks..."

# Get project root directory
PROJECT_ROOT="$(dirname "$0")/../.."
cd "$PROJECT_ROOT"

# Get list of files to be pushed (from local commits not yet on remote)
remote="$1"
url="$2"

# Get the range of commits to be pushed
if git rev-parse --verify HEAD >/dev/null 2>&1; then
    # Check if we have commits to push
    range=$(git rev-list --count @{u}..HEAD 2>/dev/null || echo "0")
    if [ "$range" = "0" ]; then
        echo "No new commits to push, skipping code quality checks."
        exit 0
    fi
    
    # Get changed files in commits to be pushed
    changed_files=$(git diff --name-only @{u}..HEAD 2>/dev/null || git diff --name-only --cached)
else
    # If no HEAD (initial commit), check staged files
    changed_files=$(git diff --name-only --cached)
fi

# Check for Go files in the changed files
go_files=$(echo "$changed_files" | grep -E '^backend/.*\.go$' || true)

# Check for frontend files in the changed files (exclude node_modules)
frontend_files=$(echo "$changed_files" | grep -E '^ui/src/.*\.(ts|tsx|js|jsx)$' || true)

if [ -z "$go_files" ] && [ -z "$frontend_files" ]; then
    echo "No Go or frontend files changed, skipping code quality checks."
    exit 0
fi

# Backend Go files check
if [ -n "$go_files" ]; then
    echo "Running backend code quality checks..."
    
    cd backend
    
    # Run code formatting check
    echo "Checking Go code format..."
    if ! make check-fmt; then
        echo "❌ Go code format check failed. Please run 'make fmt' in backend directory."
        exit 1
    fi
    
    # Run go vet
    echo "Running go vet..."
    if ! make vet; then
        echo "❌ go vet failed. Please fix the issues before pushing."
        exit 1
    fi
    
    # Run linter
    echo "Running golangci-lint..."
    if ! make lint; then
        echo "❌ Go linter failed. Please fix the issues before pushing."
        exit 1
    fi
    
    # Run go mod tidy check
    echo "Checking go.mod and go.sum..."
    if ! make tidy; then
        echo "❌ go mod tidy failed. Please run 'make tidy' in backend directory."
        exit 1
    fi
    
    cd ..
fi

# Frontend files check
if [ -n "$frontend_files" ]; then
    echo "Running frontend code quality checks..."
    
    cd ui
    
    # Check if package.json exists
    if [ ! -f "package.json" ]; then
        echo "❌ package.json not found in ui directory."
        exit 1
    fi
    
    # Run ESLint if available
    if npm list eslint >/dev/null 2>&1; then
        echo "Running ESLint..."
        if ! npm run lint 2>/dev/null; then
            echo "❌ ESLint failed. Please fix the issues before pushing."
            exit 1
        fi
    else
        echo "⚠️  ESLint not found, skipping frontend linting."
    fi
    
    # Run type check if TypeScript is used
    if [ -f "tsconfig.json" ]; then
        echo "Running TypeScript type check..."
        if ! npx tsc --noEmit 2>/dev/null; then
            echo "❌ TypeScript type check failed. Please fix the issues before pushing."
            exit 1
        fi
    fi
    
    # Run build check
    echo "Running build check..."
    if ! npm run build 2>/dev/null; then
        echo "❌ Frontend build failed. Please fix the issues before pushing."
        exit 1
    fi
    
    cd ..
fi

echo "All code quality checks passed! ✅"
echo "Proceeding with push..."