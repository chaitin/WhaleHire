#!/bin/bash

# Git pre-commit hook for code quality checks
# This hook runs before committing changes

set -e

echo "Running pre-commit code quality checks..."

# Get project root directory
PROJECT_ROOT="$(dirname "$0")/../.."
cd "$PROJECT_ROOT"

# Check for Go files in backend
go_files=$(git diff --cached --name-only --diff-filter=ACM | grep '^backend/.*\.go$' || true)

# Check for frontend files (exclude node_modules)
frontend_files=$(git diff --cached --name-only --diff-filter=ACM | grep '^frontend/src/.*\.(ts|tsx|js|jsx)$' || true)

if [ -z "$go_files" ] && [ -z "$frontend_files" ]; then
    echo "No Go or frontend files to check, skipping code quality checks."
    exit 0
fi

# Backend Go files check
if [ -n "$go_files" ]; then
    echo "Found Go files to check: $go_files"
    echo "Running backend code quality checks..."
    
    cd backend
    
    # Run code formatting check
    echo "Checking Go code format..."
    if ! make check-fmt; then
        echo "❌ Go code format check failed. Please run 'make fmt' in backend directory."
        exit 1
    fi
    
    # Run go vet
    echo "Running go vet..."
    if ! make vet; then
        echo "❌ go vet failed. Please fix the issues before committing."
        exit 1
    fi
    
    # Run linter
    echo "Running golangci-lint..."
    if ! make lint; then
        echo "❌ Go linter failed. Please fix the issues before committing."
        exit 1
    fi
    
    # Run go mod tidy check
    echo "Checking go.mod and go.sum..."
    if ! make tidy; then
        echo "❌ go mod tidy failed. Please run 'make tidy' in backend directory."
        exit 1
    fi
    
    cd ..
fi

# Frontend files check
if [ -n "$frontend_files" ]; then
    echo "Found frontend files to check: $frontend_files"
    echo "Running frontend code quality checks..."
    
    cd frontend
    
    # Check if package.json exists
    if [ ! -f "package.json" ]; then
        echo "❌ package.json not found in frontend directory."
        exit 1
    fi
    
    # Run code quality checks using Makefile
    echo "Running frontend code quality checks..."
    if ! make quality-check 2>/dev/null; then
        echo "❌ Frontend code quality checks failed. Please fix the issues before committing."
        exit 1
    fi
    
    cd ..
fi

echo "All code quality checks passed! ✅"
echo "Proceeding with commit..."